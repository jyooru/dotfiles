From e5867e8d12ff2f72e45394dafa42200bf90cc465 Mon Sep 17 00:00:00 2001
From: Joel <joel@joel.tokyo>
Date: Sun, 12 Dec 2021 13:44:29 +1000
Subject: [PATCH 1/3] feat: hide keyboard layout

---
 helpers/auth_x11.c | 8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

diff --git a/helpers/auth_x11.c b/helpers/auth_x11.c
index af47cee..14cefa3 100644
--- a/helpers/auth_x11.c
+++ b/helpers/auth_x11.c
@@ -342,9 +342,7 @@ void PlaySound(enum Sound snd) {
  */
 void SwitchKeyboardLayout(void) {
 #ifdef HAVE_XKB_EXT
-  if (!have_xkb_ext) {
-    return;
-  }
+  return;
 
   XkbDescPtr xkb;
   xkb = XkbGetMap(display, 0, XkbUseCoreKbd);
@@ -386,9 +384,7 @@ const char *GetIndicators(int *warning, int *have_multiple_layouts) {
   static char buf[128];
   char *p;
 
-  if (!have_xkb_ext) {
-    return "";
-  }
+  return "";
 
   XkbDescPtr xkb;
   xkb = XkbGetMap(display, 0, XkbUseCoreKbd);
-- 
2.31.1


From 22143efbfb2d6377d6622218ad5a508d35d5689d Mon Sep 17 00:00:00 2001
From: Joel <joel@joel.tokyo>
Date: Sun, 12 Dec 2021 14:31:09 +1000
Subject: [PATCH 2/3] feat: asterisks prompt without the asterisks

---
 helpers/auth_x11.c | 14 +-------------
 1 file changed, 1 insertion(+), 13 deletions(-)

diff --git a/helpers/auth_x11.c b/helpers/auth_x11.c
index 14cefa3..f1c412c 100644
--- a/helpers/auth_x11.c
+++ b/helpers/auth_x11.c
@@ -1100,19 +1100,7 @@ int Prompt(const char *msg, char **response, int echo) {
       switch (password_prompt) {
         case PASSWORD_PROMPT_ASTERISKS: {
           mblen(NULL, 0);
-          priv.pos = priv.displaylen = 0;
-          while (priv.pos < priv.pwlen) {
-            ++priv.displaylen;
-            // Note: this won't read past priv.pwlen.
-            priv.len = mblen(priv.pwbuf + priv.pos, priv.pwlen - priv.pos);
-            if (priv.len <= 0) {
-              // This guarantees to "eat" one byte each step. Therefore,
-              // priv.displaylen <= priv.pwlen is ensured.
-              break;
-            }
-            priv.pos += priv.len;
-          }
-          memset(priv.displaybuf, '*', priv.displaylen);
+          priv.displaylen = 0;
           // Note that priv.pwlen <= sizeof(priv.pwbuf) and thus
           // priv.pwlen + 2 <= sizeof(priv.displaybuf).
           priv.displaybuf[priv.displaylen] = blink_state ? ' ' : *cursor;
-- 
2.31.1
